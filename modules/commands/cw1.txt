const puppeteer = require('puppeteer-core');
const fs = require('fs-extra');
const path = require('path');

module.exports.config = {
    name: "capweb",
    version: "1.0.0",
    hasPermssion: 0,
    credits: "TatsuYTB",
    description: "Chá»¥p mÃ n hÃ¬nh má»™t trang web theo URL ngÆ°á»i dÃ¹ng cung cáº¥p",
    commandCategory: "Tiá»‡n Ã­ch",
    usages: ["capweb <URL>"],
    cooldowns: 60,
    dependencies: {"puppeteer-core": ""}
};

module.exports.run = async function({ api, event, args }) {
    if (!args[0]) {
        console.log("No URL provided");
        return api.sendMessage("ğ•ğ®ğ¢ ğ¥ğ¨Ì€ğ§ğ  ğ§ğ¡ğšÌ£Ì‚ğ© ğ”ğ‘ğ‹ ğœğ®Ì‰ğš ğ­ğ«ğšğ§ğ  ğ°ğğ› ğœğšÌ‚Ì€ğ§ ğœğ¡ğ®Ì£ğ©!", event.threadID);
    }

    const url = args[0];
    console.log("URL received: ", url);

    if (!url.startsWith("http://") && !url.startsWith("https://")) {
        console.log("Invalid URL format");
        return api.sendMessage("ğ”ğ‘ğ‹ ğ¤ğ¡ğ¨Ì‚ğ§ğ  ğ¡ğ¨Ì›Ì£ğ© ğ¥ğÌ£Ì‚ ğ¯ğ®ğ¢ ğ¥ğ¨Ì€ğ§ğ  ğ§ğ¡ğšÌ£Ì‚ğ© ğ®ğ«ğ¥ ğœğ¨Ì ğœğšÌ‰ ğ¡ğ­ğ­ğ© ğ¡ğ¨ğšÌ£Ì†ğœ ğ¡ğ­ğ­ğ©ğ¬ !!!", event.threadID);
    }

    api.sendMessage("ğƒğšğ§ğ  ğœğ¡ğ®Ì£ğ© ğšÌ‰ğ§ğ¡ ğ¦ğšÌ€ğ§ ğ¡ğ¢Ì€ğ§ğ¡, ğ¯ğ®ğ¢ ğ¥ğ¨Ì€ğ§ğ  ğœğ¡ğ¨Ì›Ì€...", event.threadID, async () => {
        try {
            console.log("Launching Puppeteer...");
            const browser = await puppeteer.launch({
                executablePath: 'C:/Users/Administrator/Desktop/chromium/chromium.exe',
                args: ['--no-sandbox', '--disable-setuid-sandbox'],
                headless: true
            });
            console.log("Puppeteer launched successfully");

            const page = await browser.newPage();
            console.log("New page created");

            await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36');
            console.log("User-Agent set");

            await page.goto(url, { waitUntil: 'networkidle2', timeout: 60000 });
            console.log("Page loaded successfully: ", url);

            await page.setViewport({ width: 1920, height: 1080 });
            console.log("Viewport set to 1920x1080");

            const screenshotPath = path.join(__dirname, 'screenshot.png');
            await page.screenshot({ path: screenshotPath });
            console.log("Screenshot taken and saved at: ", screenshotPath);

            await browser.close();
            console.log("Browser closed successfully");

            api.sendMessage({
                body: `ğ€Ì‰ğ§ğ¡ ğœğ®Ì‰ğš ğ­ğ«ğšğ§ğ  ğ°ğğ›: ${url}`,
                attachment: fs.createReadStream(screenshotPath)
            }, event.threadID, () => {
                fs.unlinkSync(screenshotPath);
                console.log("Screenshot file deleted");
            });
        } catch (error) {
            console.error('Error while taking screenshot:', error);
            console.error(error.stack);
            await browser.close();
            api.sendMessage("ğƒğšÌƒ ğ±ğšÌ‰ğ² ğ«ğš ğ¥ğ¨Ì‚Ìƒğ¢ ğ¤ğ¡ğ¢ ğœğ¡ğ®Ì£ğ© ğšÌ‰ğ§ğ¡ ğ¦ğšÌ€ğ§ ğ¡ğ¢Ì€ğ§ğ¡!", event.threadID);
        }
    });
};
