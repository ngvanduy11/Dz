const fs = require('fs');
const path = require('path');
const schedule = require('node-schedule');
const moment = require('moment-timezone');

module.exports.config = {
    name: "autoads",
    version: "1.0.0",
    hasPermssion: 3,
    credits: "TatsuYTB",
    description: "ADS",
    commandCategory: "Há»‡ Thá»‘ng",
    usages: "",
    cooldowns: 5,
};

module.exports.languages = {
    "vi": {},
    "en": {}
};

const sentLogDir = path.join(__dirname, 'data');
const sentLogPath = path.join(sentLogDir, 'sentLog.json');

// Function to ensure sent log file and directory exist
const ensureSentLogExists = () => {
    if (!fs.existsSync(sentLogDir)) {
        fs.mkdirSync(sentLogDir, { recursive: true });
    }
    if (!fs.existsSync(sentLogPath)) {
        fs.writeFileSync(sentLogPath, JSON.stringify({}));
    }
};

// Function to load sent log
const loadSentLog = () => {
    ensureSentLogExists();
    return JSON.parse(fs.readFileSync(sentLogPath));
};

// Function to save sent log
const saveSentLog = (log) => {
    ensureSentLogExists();
    fs.writeFileSync(sentLogPath, JSON.stringify(log, null, 2));
};

const shareContactToAllThreads = async (api) => {
    try {
        console.log('Starting shareContactToAllThreads function');
        const adminContact = global.config.ADMINBOT[0];
        const message = '--->ğ“ğ¢ğ§ ğğ¡ğšÌ†Ìğ§ ğ“ğ®Ì›Ì£ ğƒğ¨Ì£Ì‚ğ§ğ <---\n\n->ğ€ğğ¦ğ¢ğ§ ğœğ®ğ§ğ  ğœğšÌ‚Ìğ© ğğ¢Ì£ğœğ¡ ğ•ğ®Ì£<-\n\nğ…ğ€ğ‚ğ„ğğğğŠ: ğ‹ğ¢ğ¤ğ, ğ…ğ¨ğ¥ğ¥ğ¨ğ°, ğ‚ğ¦ğ­, ğŒğšÌ†Ìğ­ ğ¥ğ¢ğ¯ğ, ğ•ğ¢ğğ° ğ¯ğ¢ğğğ¨, ğ•ğ¢ğğ° ğ¬ğ­ğ¨ğ«ğ², ğ“ğšÌ†ğ§ğ  ğ­ğ¡ğšÌ€ğ§ğ¡ ğ¯ğ¢ğÌ‚ğ§ ğ§ğ¡ğ¨Ìğ¦ ğŸğ›\n\nğˆğğ’ğ“ğ€ğ†ğ‘ğ€ğŒ: ğ‹ğ¢ğ¤ğ, ğ…ğ¨ğ¥ğ¥ğ¨ğ°\n\nğ“ğˆğŠğ“ğğŠ: ğ‹ğ¢ğ¤ğ, ğ…ğ¨ğ¥ğ¥ğ¨ğ°, ğ‚ğ¦ğ­, ğ’ğ¡ğšğ«ğ, ğŒğšÌ†Ìğ­ ğ¥ğ¢ğ¯ğ, ğ•ğ¢ğğ° ğ¯ğ¢ğğğ¨\n\nğ˜ğğ”ğ“ğ”ğğ„: ğ‹ğ¢ğ¤ğ, ğ•ğ¢ğğ°\n\nğ“ğ–ğˆğ“ğ“ğ„ğ‘: ğ‹ğ¢ğ¤ğ, ğ…ğ¨ğ¥ğ¥ğ¨ğ°\n\n->ğ‚ğ¨Ì ğ§ğ¡ğ® ğœğšÌ‚Ì€ğ® ğ›ğ®ğŸğŸ ğ¥ğ¢ğÌ‚ğ§ ğ¡ğÌ£Ì‚ ğšğğ¦ğ¢ğ§ ğğÌ‚Ì‰ ğ§ğ¡ğšÌ£Ì‚ğ§ ğ®Ì›ğ® ğğšÌƒğ¢ ğ¯ğšÌ€ ğ ğ¢ğšÌ ğœğšÌ‰ ğ­ğ¨Ì‚Ìğ­ ğ§ğ¡ğšÌ‚Ìğ­<-\n\n--->ğ“ğšğ­ğ¬ğ®ğ˜ğ“ğ<---';

        const allThread = global.data.allThreadID;
        console.log('All thread IDs:', allThread);

        const sentLog = loadSentLog();
        const currentTimeSlot = moment().format('YYYY-MM-DD HH:mm');

        for (const threadID of allThread) {
            if (!sentLog[currentTimeSlot] || !sentLog[currentTimeSlot].includes(threadID)) {
                try {
                    console.log('Sharing contact to thread ID:', threadID);
                    await new Promise((resolve, reject) => {
                        api.shareContact(message, adminContact, threadID, (error) => {
                            if (error) {
                                reject(`Failed to share contact to thread ${threadID}: ${error}`);
                            } else {
                                resolve();
                            }
                        });
                    });
                    if (!sentLog[currentTimeSlot]) {
                        sentLog[currentTimeSlot] = [];
                    }
                    sentLog[currentTimeSlot].push(threadID);
                    saveSentLog(sentLog);
                } catch (error) {
                    console.error(error);
                }
            } else {
                console.log(`Already sent message to thread ID: ${threadID} for this time slot`);
            }
        }
        console.log('Finished sharing contacts');
    } catch (error) {
        console.error(`Error in shareContactToAllThreads: ${error}`);
    }
};

module.exports.onLoad = function({ api }) {
    console.log('Scheduling tasks for shareContactToAllThreads');

    const timeZone = 'Asia/Ho_Chi_Minh';

    // Schedule tasks at specific times
    schedule.scheduleJob({ hour: 8, minute: 0, tz: timeZone }, () => {
        console.log('Running scheduled task at 8:00 AM');
        shareContactToAllThreads(api);
    });

    schedule.scheduleJob({ hour: 13, minute: 0, tz: timeZone }, () => {
        console.log('Running scheduled task at 12:00 PM');
        shareContactToAllThreads(api);
    });

    schedule.scheduleJob({ hour: 20, minute: 00, tz: timeZone }, () => {
        console.log('Running scheduled task at 8:00 PM');
        shareContactToAllThreads(api);
    });

    console.log('Scheduled tasks for shareContactToAllThreads at 8 AM, 12 PM, 3 PM, and 8 PM');
};

module.exports.run = function({ api, event }) {
    console.log('Run function called');
    shareContactToAllThreads(api);
    api.sendMessage("ÄÃ£ chia sáº» liÃªn há»‡ tá»›i táº¥t cáº£ cÃ¡c nhÃ³m.", event.threadID);
};
